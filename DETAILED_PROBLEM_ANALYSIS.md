# üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ –ú–ò–ö–°–ò–ù–ê MixinS21PacketChunkDataUltramine

## üìä –°–ò–ú–ü–¢–û–ú–´ –ü–†–û–ë–õ–ï–ú

### old.java (—Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –≤ git):
- ‚úÖ –û–±—ã—á–Ω—ã–π –º–∏—Ä –±–µ–∑ angelica: OK
- ‚úÖ –û–±—ã—á–Ω—ã–π –º–∏—Ä —Å angelica: OK
- ‚ùå –≠–Ω–¥ –º–∏—Ä –±–µ–∑ angelica: **Connection lost. Bad compressed data format**
- ‚ùå –≠–Ω–¥ –º–∏—Ä —Å angelica: **Connection lost. Bad compressed data format**

### new.java (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è):
- ‚ùå –û–±—ã—á–Ω—ã–π –º–∏—Ä –±–µ–∑ angelica: **–∫—Ä–∞—à —á–µ—Ä–µ–∑ ~10 —Å–µ–∫—É–Ω–¥**
- ‚úÖ –û–±—ã—á–Ω—ã–π –º–∏—Ä —Å angelica: OK
- ‚ö†Ô∏è –≠–Ω–¥ –º–∏—Ä –±–µ–∑ angelica: OK (—Ä–∞–Ω–¥–æ–º–Ω—ã–µ –±–ª–æ–∫–∏ –ø–µ—Ä–≤—ã–µ —Å–µ–∫—É–Ω–¥—ã)
- ‚ö†Ô∏è –≠–Ω–¥ –º–∏—Ä —Å angelica: **–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —á–∞–Ω–∫–∏, —Ä–∞–Ω–¥–æ–º–Ω—ã–µ –±–ª–æ–∫–∏**

---

## üêõ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê ‚Ññ1: –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ï –ß–¢–ï–ù–ò–ï NIBBLE –ú–ê–°–°–ò–í–û–í

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ new.java (—Å—Ç—Ä–æ–∫–∏ 172-178)

```java
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LINEAR –∏–Ω–¥–µ–∫—Å
int linearIndex = 0;
for (int y = 0; y < 16; y++) {
    for (int z = 0; z < 16; z++) {
        for (int x = 0; x < 16; x++) {
            int lsbVal = lsb[linearIndex] & 0xFF;
            int msbVal = get4bits(msb, linearIndex);  // ‚ùå –û–®–ò–ë–ö–ê!
            linearIndex++;
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ?

**Ultramine –∏—Å–ø–æ–ª—å–∑—É–µ—Ç COORDINATE-ORDERED —Ñ–æ—Ä–º–∞—Ç –¥–ª—è nibble –º–∞—Å—Å–∏–≤–æ–≤!**

–ò–∑ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞:
- `LSB` –º–∞—Å—Å–∏–≤: linear ordering (–∏–Ω–¥–µ–∫—Å 0,1,2,3...)
- `MSB` –º–∞—Å—Å–∏–≤: **coordinate ordering** (–∏–Ω–¥–µ–∫—Å = `y << 8 | z << 4 | x`)
- `Metadata` –º–∞—Å—Å–∏–≤: **coordinate ordering** (–∏–Ω–¥–µ–∫—Å = `y << 8 | z << 4 | x`)

–§—É–Ω–∫—Ü–∏—è `get4bits()` —á–∏—Ç–∞–µ—Ç –∏–∑ LINEAR –∏–Ω–¥–µ–∫—Å–∞:
```java
private static int get4bits(byte[] arr, int index) {
    int byteIndex = index >> 1;
    return (index & 1) == 0 ? (arr[byteIndex] & 0xF) : ((arr[byteIndex] >> 4) & 0xF);
}
```

–ù–æ –Ω—É–∂–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get4bitsCoordinate()`:
```java
private static int get4bitsCoordinate(byte[] arr, int x, int y, int z) {
    int index = y << 8 | z << 4 | x;  // ‚úÖ COORDINATE ORDER
    int byteIndex = index >> 1;
    return (index & 1) == 0 ? (arr[byteIndex] & 0xF) : ((arr[byteIndex] >> 4) & 0xF);
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ß–∏—Ç–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ nibbles ‚Üí –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ block IDs ‚Üí **—Ä–∞–Ω–¥–æ–º–Ω—ã–µ –±–ª–æ–∫–∏**

---

## üêõ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê ‚Ññ2: –ß–¢–ï–ù–ò–ï –ò–ó –ü–£–°–¢–´–• NEID –ú–ê–°–°–ò–í–û–í

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ old.java deflate() (—Å—Ç—Ä–æ–∫–∏ 370-388)

```java
// PHASE 1: Write all 16-bit blocks
for (int i = 0; i < ebsArr.length; i++) {
    if ((mask & (1 << i)) == 0) continue;
    ExtendedBlockStorage ebs = ebsArr[i];

    IExtendedBlockStorageMixin ebsMixin = (IExtendedBlockStorageMixin) ebs;
    short[] blockArray = ebsMixin.getBlock16BArray();  // ‚ùå –ú–û–ñ–ï–¢ –ë–´–¢–¨ NULL!

    if (blockArray != null) {
        for (int j = 0; j < 4096; j++) {
            int blockId = blockArray[j] & 0xFFFF;
            // ...
        }
    } else {
        LOGGER.warn("Block16BArray is null for EBS {}, using zeros", i);
        offset += 8192;  // ‚ùå –ó–ê–ü–ò–°–´–í–ê–Æ–¢–°–Ø –ù–£–õ–ò!
    }
}
```

### –ü–æ—á–µ–º—É NEID –º–∞—Å—Å–∏–≤—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏?

**ChunkSnapshot –∫–æ–ø–∏—Ä—É–µ—Ç MemSlot, –Ω–æ –ù–ï –∫–æ–ø–∏—Ä—É–µ—Ç NEID –º–∞—Å—Å–∏–≤—ã!**

–ò–∑ –∞–Ω–∞–ª–∏–∑–∞ MixinExtendedBlockStorageUltramine:
- `copy()` –º–µ—Ç–æ–¥ (—Å—Ç—Ä–æ–∫–∏ 61-94) –∫–æ–ø–∏—Ä—É–µ—Ç NEID –º–∞—Å—Å–∏–≤—ã
- –ù–æ ChunkSnapshot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!
- ChunkSnapshot –∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ MemSlot
- NEID –º–∞—Å—Å–∏–≤—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏ (null –∏–ª–∏ zeros)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** deflate() —á–∏—Ç–∞–µ—Ç –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã ‚Üí –≤—Å–µ –±–ª–æ–∫–∏ = 0 ‚Üí **–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

---

## üêõ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê ‚Ññ3: –§–û–†–ú–ê–¢ –î–ê–ù–ù–´–• –î–õ–Ø –ú–ò–†–û–í –ë–ï–ó –ù–ï–ë–ê

### –ü—Ä–æ–±–ª–µ–º–∞ —Å hasNoSky –≤ old.java

–ò–∑ analysis_of_data_sent_to_the_client_with_a_focus_on_skyless_worlds.md:

**The End –∏–º–µ–µ—Ç `hasNoSky = true`**

**–û–∂–∏–¥–∞–µ–º—ã–π NEID —Ñ–æ—Ä–º–∞—Ç:**
```
[Blocks16 –≤—Å–µ EBS]    ‚Üê 8192 –±–∞–π—Ç √ó –∫–æ–ª-–≤–æ —Å–µ–∫—Ü–∏–π
[Meta16 –≤—Å–µ EBS]      ‚Üê 8192 –±–∞–π—Ç √ó –∫–æ–ª-–≤–æ —Å–µ–∫—Ü–∏–π
[BlockLight –≤—Å–µ EBS]  ‚Üê 2048 –±–∞–π—Ç √ó –∫–æ–ª-–≤–æ —Å–µ–∫—Ü–∏–π
[Biome]               ‚Üê 256 –±–∞–π—Ç
```

**–ù–ï–¢ SkyLight —Å–µ–∫—Ü–∏–∏!** (—ç–∫–æ–Ω–æ–º–∏—è ~32KB –Ω–∞ —á–∞–Ω–∫)

**–ù–æ old.java –≤ func_149269_a() (—Å—Ç—Ä–æ–∫–∞ 214):**
```java
// PHASE 4: Write all SkyLight (2048 bytes per EBS)
if (!isWorldHasNoSky(chunk)) {  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    for (int sectionIndex = 0; sectionIndex < 16; sectionIndex++) {
        // ...
    }
}
```

**–ê –≤ deflate() (—Å—Ç—Ä–æ–∫–∞ 420):**
```java
// PHASE 4: Write SkyLight from MemSlot
if (!hasNoSky) {  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    for (int i = 0; i < ebsArr.length; i++) {
        // ...
    }
}
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è! –ù–æ...

### –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ß—Ç–µ–Ω–∏–µ –∏–∑ –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤

–î–∞–∂–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π hasNoSky, –µ—Å–ª–∏ NEID –º–∞—Å—Å–∏–≤—ã –ø—É—Å—Ç—ã–µ (–ø—Ä–æ–±–ª–µ–º–∞ ‚Ññ2), –¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ!

–ö–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å:
1. Deflate –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
2. –ü–∞—Ä—Å–∏—Ç –±–ª–æ–∫–∏ (–≤—Å–µ –Ω—É–ª–∏ –∏–∑-–∑–∞ –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤)
3. –ü–∞—Ä—Å–∏—Ç metadata (–≤—Å–µ –Ω—É–ª–∏)
4. –ü–∞—Ä—Å–∏—Ç BlockLight (–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏–∑ MemSlot)
5. –û–∂–∏–¥–∞–µ—Ç Biome, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `Bad compressed data format` - –∫–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

---

## üîß –ü–û–ß–ï–ú–£ new.java –†–ê–ë–û–¢–ê–ï–¢ –õ–£–ß–®–ï –° ANGELICA?

Angelica - –º–æ–¥ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤**
   - Angelica –º–æ–∂–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫–∏ —Å ID 0
   - Vanilla –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –∫—Ä–∞—à–∏—Ç—å—Å—è –Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

2. **–î—Ä—É–≥–æ–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞–Ω–∫–æ–≤**
   - Angelica –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —á–∞–Ω–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
   - –°–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏

3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏**
   - Angelica –∫—ç—à–∏—Ä—É–µ—Ç –º–µ—à–∏ —á–∞–Ω–∫–æ–≤
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –º–æ–≥—É—Ç –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å—Å—è

---

## ‚úÖ –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. **–ß–∏—Ç–∞—Ç—å –∏–∑ MemSlot, –∞ –ù–ï –∏–∑ NEID –º–∞—Å—Å–∏–≤–æ–≤**
   - MemSlot –≤—Å–µ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω –≤ ChunkSnapshot
   - NEID –º–∞—Å—Å–∏–≤—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å coordinate ordering –¥–ª—è nibbles**
   - `get4bitsCoordinate(msb, x, y, z)` –≤–º–µ—Å—Ç–æ `get4bits(msb, linearIndex)`
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ MSB –∏ Metadata

3. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å hasNoSky**
   - –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å SkyLight –¥–ª—è The End/Nether
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –æ–±–æ–∏—Ö –ø—É—Ç—è—Ö (func_149269_a –∏ deflate)

4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ –¥–ª—è –æ–±–æ–∏—Ö –ø—É—Ç–µ–π**
   - func_149269_a() –∏ deflate() –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç
   - –ò–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

---

## üìã –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –®–∞–≥ 1: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `createNeidFormatDataFromMemSlot()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ –æ–±–æ–∏—Ö –ø—É—Ç—è—Ö (func_149269_a –∏ deflate)

### –®–∞–≥ 2: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ nibbles
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get4bitsCoordinate()` –¥–ª—è MSB –∏ Metadata
- LSB —á–∏—Ç–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é (—É–∂–µ –≤ linear order)

### –®–∞–≥ 3: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ hasNoSky
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å hasNoSky –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é SkyLight
- –í func_149269_a: `!isWorldHasNoSky(chunk)`
- –í deflate: `!hasNoSky` –∏–∑ ChunkSnapshot

### –®–∞–≥ 4: –£–¥–∞–ª–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç NEID –º–∞—Å—Å–∏–≤–æ–≤
- –í—Å–µ–≥–¥–∞ —á–∏—Ç–∞—Ç—å –∏–∑ MemSlot
- NEID –º–∞—Å—Å–∏–≤—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –û–±—ã—á–Ω—ã–π –º–∏—Ä –±–µ–∑ angelica: OK
- ‚úÖ –û–±—ã—á–Ω—ã–π –º–∏—Ä —Å angelica: OK
- ‚úÖ –≠–Ω–¥ –º–∏—Ä –±–µ–∑ angelica: OK
- ‚úÖ –≠–Ω–¥ –º–∏—Ä —Å angelica: OK
- ‚úÖ –ù–µ—Ç —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤
- ‚úÖ –ù–µ—Ç –∫—Ä–∞—à–µ–π
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "Bad compressed data format"

---

## üìù –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ô–õ–´ –î–õ–Ø –ü–û–ù–ò–ú–ê–ù–ò–Ø

1. **MixinExtendedBlockStorageUltramine.java:100-104**
   - –§—É–Ω–∫—Ü–∏—è `get4bitsCoordinate()` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ nibbles

2. **old.java:151-175**
   - func_149269_a() –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞–µ—Ç –∏–∑ MemSlot —Å coordinate ordering

3. **old.java:370-428**
   - deflate() –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û —á–∏—Ç–∞–µ—Ç –∏–∑ NEID –º–∞—Å—Å–∏–≤–æ–≤ (–º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–µ)

4. **new.java:172-186**
   - –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç linear ordering –¥–ª—è nibbles

5. **analysis_of_data_sent_to_the_client...md:227-238**
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ hasNoSky –∏ SkyLight
