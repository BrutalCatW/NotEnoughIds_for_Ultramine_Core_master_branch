ĞŸĞĞ›ĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ— ĞŸĞ ĞĞ•ĞšĞ¢Ğ ULTRAMINE CORE
1. ĞĞ‘Ğ—ĞĞ  ĞŸĞ ĞĞ•ĞšĞ¢Ğ
Ultramine Core - ÑÑ‚Ğ¾ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ ÑĞ´Ñ€Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Minecraft 1.7.10, Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ¾Ğµ Ğ½Ğ° Ğ±Ğ°Ğ·Ğµ Minecraft Forge. ĞŸÑ€Ğ¾ĞµĞºÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ 216 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Java-Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ² Ğ¿Ğ°ĞºĞµÑ‚Ğµ org.ultramine.* Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ vanilla ĞºĞ¾Ğ´ Minecraft (~1700+ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²).

ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:
Ğ’ĞµÑ€ÑĞ¸Ñ Minecraft: 1.7.10
Java Ğ²ĞµÑ€ÑĞ¸Ñ: 1.8
ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹: 2,039 Java Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ: WTFPL
Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞ±Ğ¾Ñ€ĞºĞ¸: Gradle
2. Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ¥Ğ ĞĞĞ•ĞĞ˜Ğ¯ Ğ˜ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ˜ Ğ§ĞĞĞšĞĞ’
2.1. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:
ChunkProviderServer (ChunkProviderServer.java:53)

Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹, Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¸ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ ChunkLoader Ğ¸ ChunkProvider
ChunkMap (ChunkMap.java:12)

Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ñ… Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ HashIntObjMaps Ğ¸Ğ· Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Koloboke Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
ĞšĞ»ÑÑ‡: Ñ…ÑÑˆ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚ Ñ‡Ğ°Ğ½ĞºĞ° (int), Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ: Ğ¾Ğ±ÑŠĞµĞºÑ‚ Chunk
AnvilChunkLoader (AnvilChunkLoader.java:45)

ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Anvil (NBT ÑĞ¶Ğ°Ñ‚Ñ‹Ğ¹ Ğ² region Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…)
Ğ˜Ğ¼ĞµĞµÑ‚ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ğ¾Ñ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ pendingSaves
2.2. ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°:
// ChunkProviderServer.java:136-182
public Chunk loadChunk(int x, int z, Runnable callback)
ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ:

ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ° Ğ² ChunkMap
Ğ•ÑĞ»Ğ¸ Ñ‡Ğ°Ğ½Ğº ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ… â†’ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· ChunkIOExecutor
Ğ•ÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ½ĞµÑ‚ â†’ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· currentChunkProvider.provideChunk()
Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² ChunkMap
Ğ’Ñ‹Ğ·Ğ¾Ğ² chunk.onChunkLoad()
ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ†Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ° (Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€, Ñ€ÑƒĞ´ Ğ¸ Ñ‚.Ğ´.)
ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°:
// ChunkProviderServer.java:482-503
public boolean loadAsync(int x, int z, boolean generateOnRequest, IChunkLoadCallback callback)
ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:

Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ChunkIOExecutor Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ² Ñ„Ğ¾Ğ½Ğµ
ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ callback Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸
ĞœĞ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ´Ğ¸ÑƒÑ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ñ ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¼ callback
ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°
2.3. ĞŸÑ€Ğ¾Ñ†ĞµÑÑ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ:
AnvilChunkLoader.java:206-228

public void saveChunk(World world, Chunk chunk)
Ğ­Ñ‚Ğ°Ğ¿Ñ‹:

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ NBT ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹:

Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· ExtendedBlockStorage
Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ entities, tile entities
Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ pending block updates
Ğ‘Ğ¸Ğ¾Ğ¼Ñ‹ Ğ¸ ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ²Ñ‹ÑĞ¾Ñ‚
ĞÑ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ:

Ğ§Ğ°Ğ½Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ² pendingSaves (IntObjMap)
Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ Ñ‡ĞµÑ€ĞµĞ· ThreadedFileIOBase
ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸: 64 Ñ‡Ğ°Ğ½ĞºĞ°
Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Region Ñ„Ğ°Ğ¹Ğ»:

Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ RegionFileCache Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ region Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸
Ğ¡Ğ¶Ğ°Ñ‚Ğ¸Ğµ NBT Ñ‡ĞµÑ€ĞµĞ· CompressedStreamTools
ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ: region/r.X.Z.mca
2.4. ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
EbsSaveFakeNbt Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:
AnvilChunkLoader.java:378 - Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² NBT Ğ¼Ğ°ÑÑĞ¸Ğ²Ñ‹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° ExtendedBlockStorage:

nbttaglist.appendTag(new EbsSaveFakeNbt(extendedblockstorage.copy(), !flag));
ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:

ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ 10KB+ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° ĞºĞ°Ğ¶Ğ´ÑƒÑ ÑĞµĞºÑ†Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ°
Ğ›ĞµĞ½Ğ¸Ğ²Ğ¾Ğµ Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² NBT Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ GC pressure
Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
ChunkProviderServer.java:462-463

ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ: 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚ (FULL_SAVE_INTERVAL)
ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ: 64 (MAX_SAVE_QUEUE_SIZE)
Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
3. Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ MEMSLOT - OFF-HEAP Ğ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ‘Ğ›ĞĞšĞĞ’
3.1. ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ MemSlot
MemSlot - ÑÑ‚Ğ¾ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ off-heap Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‡Ğ°Ğ½ĞºĞ° (Ğ±Ğ»Ğ¾ĞºĞ¸, Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ, Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ) Ğ²Ğ½Ğµ Java heap.

ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:
Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ GC pressure Ğ½Ğ° ~70%
Ğ§Ğ°Ğ½ĞºĞ¸ Ğ½Ğµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ² Java heap
Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Unsafe.copyMemory()
Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸: 6GB (Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğ¹)
3.2. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° MemSlot
Ğ Ğ°Ğ·Ğ¼ĞµÑ€ ÑĞ»Ğ¾Ñ‚Ğ°:
// AbstractUnsafeMemSlot.java:10
static final int SLOT_SIZE = 4096*3; // 12,288 Ğ±Ğ°Ğ¹Ñ‚
Layout 7 (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ):
Unsafe7MemSlot.java:5-15

Offset 0:    LSB (4096 bytes)     - ĞœĞ»Ğ°Ğ´ÑˆĞ¸Ğµ 8 Ğ±Ğ¸Ñ‚ ID Ğ±Ğ»Ğ¾ĞºĞ°
Offset 4096: MSB (2048 bytes)     - Ğ¡Ñ‚Ğ°Ñ€ÑˆĞ¸Ğµ 4 Ğ±Ğ¸Ñ‚Ğ° ID Ğ±Ğ»Ğ¾ĞºĞ° (nibble array)
Offset 6144: META (2048 bytes)    - ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² (nibble array)
Offset 8192: BLOCKLIGHT (2048 b)  - ĞÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² (nibble array)
Offset 10240: SKYLIGHT (2048 b)   - ĞĞµĞ±ĞµÑĞ½Ğ¾Ğµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ (nibble array)
Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: 12,288 Ğ±Ğ°Ğ¹Ñ‚ Ğ½Ğ° ÑĞµĞºÑ†Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ° (16x16x16 Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²)

Layout 8 (Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹):
Unsafe8MemSlot.java:8-12

Char-based layout: ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº = 2 Ğ±Ğ°Ğ¹Ñ‚Ğ° (char)
Ğ‘Ğ¸Ñ‚Ñ‹: [MMMM][MMMM IIII] [IIII IIII]
      Meta(4) MSB(4)  LSB(8)

Offset 0:     BlockID+Meta (8192 bytes) - ÑƒĞ¿Ğ°ĞºĞ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ID Ğ¸ Meta
Offset 8192:  BLOCKLIGHT (2048 bytes)
Offset 10240: SKYLIGHT (2048 bytes)
ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾: Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ID Ğ¸ Meta Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ĞµĞ¹ getChar().

3.3. UnsafeChunkAlloc - ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:
UnsafeChunkAlloc.java:24-110

ĞĞ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ:
public synchronized MemSlot allocateSlot()
{
    ReleasedSlot released = releasedSlots.poll();
    if(released != null)
        return slotFactory.apply(released.pointer);
    
    slots++;
    if(slots >= SLOT_LIMIT)
        throw new OutOfMemoryError("Off-heap chunk storage");
    
    return slotFactory.apply(U.allocateMemory(SLOT_SIZE));
}
ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹:

ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ñ‘Ğ½Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¼ĞµÑ‰Ğ°ÑÑ‚ÑÑ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ releasedSlots
Ğ—Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°: 5 ÑĞµĞºÑƒĞ½Ğ´ (SLOT_FREE_DELAY)
ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ data races Ğ¸ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°:

Timer thread ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 2 ÑĞµĞºÑƒĞ½Ğ´Ñ‹
ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ğµ ÑĞ»Ğ¾Ñ‚Ñ‹ (>5 ÑĞµĞº)
Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Unsafe.freeMemory()
Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹:
// UnsafeChunkAlloc.java:27
SLOT_LIMIT = 6 * (1024 * 1024 * 1024 / 12288) = ~524,288 ÑĞ»Ğ¾Ñ‚Ğ¾Ğ²
ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸: 6GB
ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°: -Dorg.ultramine.chunk.alloc.offheap.memlimit=6

3.4. ExtendedBlockStorage - Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ MemSlot
Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:
ExtendedBlockStorage.java:15-44

public class ExtendedBlockStorage
{
    private int yBase;                    // Y-ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ° (0, 16, 32, ...)
    private int blockRefCount;            // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½ĞµĞ¿ÑƒÑÑ‚Ñ‹Ñ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²
    private int tickRefCount;             // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ñ random tick
    private volatile MemSlot slot;        // Off-heap Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
}
ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ±Ğ»Ğ¾ĞºĞ°Ğ¼Ğ¸:
Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ±Ğ»Ğ¾ĞºĞ°:

// ExtendedBlockStorage.java:50-76
public void func_150818_a(int x, int y, int z, Block block)
{
    Block oldBlock = Block.getBlockById(slot.getBlockId(x, y, z));
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
    if (oldBlock != Blocks.air) {
        --blockRefCount;
        if (oldBlock.getTickRandomly()) --tickRefCount;
    }
    if (block != Blocks.air) {
        ++blockRefCount;
        if (block.getTickRandomly()) ++tickRefCount;
    }
    
    // Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² off-heap
    int id = Block.getIdFromBlock(block);
    slot.setBlockId(x, y, z, id);
}
ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ°:

// ExtendedBlockStorage.java:45-48
public Block getBlockByExtId(int x, int y, int z)
{
    return Block.getBlockById(slot.getBlockId(x, y, z));
}
3.5. Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ MemSlot
Unsafe7MemSlot - Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿:
// Unsafe7MemSlot.java:188-199
public int getBlockId(int x, int y, int z)
{
    // LSB (8 Ğ±Ğ¸Ñ‚) + MSB (4 Ğ±Ğ¸Ñ‚Ğ°) = 12-Ğ±Ğ¸Ñ‚Ğ½Ñ‹Ğ¹ ID
    return (getByte(y << 8 | z << 4 | x) & 255) | 
           (get4bits(OFFSET_MSB, x, y, z) << 8);
}

public void setBlockId(int x, int y, int z, int id)
{
    setByte(y << 8 | z << 4 | x, (byte)(id & 0xFF));
    set4bits(OFFSET_MSB, x, y, z, (id & 3840) >> 8);
}
Ğ˜Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ: y << 8 | z << 4 | x - YZX Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞµĞ¹ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ ĞºÑÑˆĞ°.

4. Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ Ğ‘Ğ›ĞĞšĞĞœĞ˜
4.1. ĞšĞ»Ğ°ÑÑ Block
Block.java:55-300

ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°:
blockRegistry: NamespacedRegistry Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²
Material: Ñ‚Ğ¸Ğ¿ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ° (rock, wood, water Ğ¸ Ñ‚.Ğ´.)
lightOpacity: Ğ½ĞµĞ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ»Ñ ÑĞ²ĞµÑ‚Ğ° (0-15)
lightValue: Ğ¸Ğ·Ğ»ÑƒÑ‡Ğ°ĞµĞ¼Ñ‹Ğ¹ ÑĞ²ĞµÑ‚ (0-15)
blockHardness: Ñ‚Ğ²Ñ‘Ñ€Ğ´Ğ¾ÑÑ‚ÑŒ (Ğ²Ñ€ĞµĞ¼Ñ Ğ»Ğ¾Ğ¼Ğ°Ğ½Ğ¸Ñ)
blockResistance: ÑĞ¾Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ğ·Ñ€Ñ‹Ğ²Ğ°Ğ¼
ID ÑĞ¸ÑÑ‚ĞµĞ¼a:
// Block.java:129-138
public static int getIdFromBlock(Block block)
{
    return blockRegistry.getIDForObject(block);
}

public static Block getBlockById(int id)
{
    Block ret = (Block)blockRegistry.getObjectById(id);
    return ret == null ? Blocks.air : ret;
}
Ğ”Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ ID: 0-4095 (12 Ğ±Ğ¸Ñ‚: 8 Ğ±Ğ¸Ñ‚ LSB + 4 Ğ±Ğ¸Ñ‚Ğ° MSB)

4.2. Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ğ² Ñ‡Ğ°Ğ½ĞºĞµ
Ğ˜ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ:
Chunk (16x16x256)
â””â”€â”€ ExtendedBlockStorage[16]  (Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 16 Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ğ¿Ğ¾ Y)
    â””â”€â”€ MemSlot               (off-heap Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ 16x16x16 Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²)
Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ±Ğ»Ğ¾ĞºÑƒ:
Chunk.java:533-565

public Block getBlock(int x, int y, int z)
{
    Block block = Blocks.air;
    
    if (y >> 4 < this.storageArrays.length)
    {
        ExtendedBlockStorage ebs = this.storageArrays[y >> 4];
        if (ebs != null)
        {
            block = ebs.getBlockByExtId(x, y & 15, z);
        }
    }
    
    return block;
}
ĞŸÑ€Ğ¾Ñ†ĞµÑÑ:

Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑĞ° ÑĞµĞºÑ†Ğ¸Ğ¸: y >> 4 (Ğ´ĞµĞ»Ğ¸Ğ¼ Y Ğ½Ğ° 16)
ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ ExtendedBlockStorage
ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ° Ğ¸Ğ· MemSlot
4.3. Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²
Chunk.java:580-701

public boolean func_150807_a(int x, int y, int z, Block newBlock, int meta)
Ğ­Ñ‚Ğ°Ğ¿Ñ‹:

ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°
ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ExtendedBlockStorage ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
Ğ’Ñ‹Ğ·Ğ¾Ğ² oldBlock.onBlockPreDestroy() Ğ¸ breakBlock()
ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ° Ğ² MemSlot
Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ/ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ TileEntity ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
Ğ’Ñ‹Ğ·Ğ¾Ğ² newBlock.onBlockAdded()
ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· relightBlock()
ĞŸĞ¾Ğ¼ĞµÑ‚ĞºĞ° Ñ‡Ğ°Ğ½ĞºĞ° ĞºĞ°Ğº Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾
5. Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ CHUNK GARBAGE COLLECTION
5.1. ChunkGC - Ğ¡Ğ±Ğ¾Ñ€Ñ‰Ğ¸Ğº Ğ¼ÑƒÑĞ¾Ñ€Ğ° Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
ChunkGC.java:19-156

ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
MIN_GC_INTERVAL: 100 Ñ‚Ğ¸ĞºĞ¾Ğ²
MAX_UNLOAD_QUEUE_SIZE: 128 Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
MAX_CHUNKS_PER_OP: 1024 Ñ‡Ğ°Ğ½ĞºĞ° Ğ·Ğ° Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´
_10_MINUTES: 12,000 Ñ‚Ğ¸ĞºĞ¾Ğ²
5.2. ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
ChunkGC.java:39-81

Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° GC:

chunkCount > chunkLimit - Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
unloadQueueSize < MAX_UNLOAD_QUEUE_SIZE - Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°
chunkDiff > minChunkDiff - Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
ĞŸÑ€Ğ¾Ñ†ĞµÑÑ:

ĞŸĞ¾Ğ´ÑÑ‡Ñ‘Ñ‚ bound Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² (Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ + persistent chunks)
ĞŸĞ¾Ğ¸ÑĞº unbound Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· findChunksForUnload()
Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ¸
Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² unloadQueue
5.3. ChunkBindState - Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
ChunkBindState.java:4-49

Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ:

NONE: ĞœĞ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ¶ĞµĞ½
PLAYER: Ğ—Ğ°Ğ½ÑÑ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ¼
LEAK: Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ (ÑƒÑ‚ĞµÑ‡ĞºĞ° Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸, Ğ²Ñ‹Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
FORGE: Ğ’ ÑĞ¿Ğ¸ÑĞºĞµ persistent chunks (Ğ½Ğµ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ)
ETERNAL: Ğ—Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ğ° Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°
5.4. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ¸
ChunkGC.java:139-155

private static class ChunkComparator implements Comparator<Chunk>
{
    public int compare(Chunk c1, Chunk c2)
    {
        float priority1 = loadTime / unbindTime;
        float priority2 = loadTime / unbindTime;
        return Float.compare(priority1, priority2);
    }
}
Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ°: Ğ§ĞµĞ¼ Ğ´Ğ¾Ğ»ÑŒÑˆĞµ Ñ‡Ğ°Ğ½Ğº Ğ±Ñ‹Ğ» Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸ Ñ‡ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾ Ñ unbind, Ñ‚ĞµĞ¼ Ğ²Ñ‹ÑˆĞµ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ¸.

6. Ğ’Ğ—ĞĞ˜ĞœĞĞ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ• ĞšĞĞœĞŸĞĞĞ•ĞĞ¢ĞĞ’
6.1. ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Ğ—ĞĞŸĞ ĞĞ¡ Ğ§ĞĞĞšĞ (Player movement, structure generation)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ChunkProviderServer.loadChunk() / loadAsync()            â”‚
â”‚    - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ChunkMap                                      â”‚
â”‚    - Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ/Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3a. Ğ˜Ğ— Ğ¤ĞĞ™Ğ›Ğ     â”‚  â”‚ 3b. Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯        â”‚
â”‚ AnvilChunkLoader â”‚  â”‚ ChunkProvider        â”‚
â”‚ - Region Ñ„Ğ°Ğ¹Ğ»Ñ‹   â”‚  â”‚ - Terrain generation â”‚
â”‚ - NBT parsing    â”‚  â”‚ - Ore generation     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ  Ğ”ĞĞĞĞ«Ğ¥                                 â”‚
â”‚    Chunk                                                     â”‚
â”‚    â””â”€â”€ ExtendedBlockStorage[16]                             â”‚
â”‚        â””â”€â”€ MemSlot (off-heap via UnsafeChunkAlloc)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯                                            â”‚
â”‚    - chunk.onChunkLoad()                                    â”‚
â”‚    - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° entities                                       â”‚
â”‚    - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° tile entities                                  â”‚
â”‚    - Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ñ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ’ ChunkMap                                    â”‚
â”‚    - ChunkBindState = PLAYER/LEAK/FORGE                     â”‚
â”‚    - Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² ChunkProviderServer                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ•                                            â”‚
â”‚    - Ğ˜Ğ³Ñ€Ğ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°: Block.getBlockById()                   â”‚
â”‚    - Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²: Chunk.func_150807_a()                â”‚
â”‚    - TileEntity operations                                   â”‚
â”‚    - Entity interactions                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. UNBIND                                                   â”‚
â”‚    - Ğ˜Ğ³Ñ€Ğ¾Ğº Ğ²Ñ‹ÑˆĞµĞ» Ğ¸Ğ· Ğ·Ğ¾Ğ½Ñ‹ / chunk loader ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½              â”‚
â”‚    - chunk.unbind() â†’ ChunkBindState = NONE                 â”‚
â”‚    - updateUnbindTime()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. CHUNK GC                                                 â”‚
â”‚    - ChunkGC.onTick() Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹                      â”‚
â”‚    - ĞŸĞ¾Ğ¸ÑĞº unbound Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²                                   â”‚
â”‚    - Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñƒ                               â”‚
â”‚    - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² unloadQueue                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ˜ Ğ’Ğ«Ğ“Ğ Ğ£Ğ—ĞšĞ                                   â”‚
â”‚     - chunk.onChunkUnload()                                 â”‚
â”‚     - AnvilChunkLoader.saveChunk() â†’ pendingSaves queue     â”‚
â”‚     - Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² region Ñ„Ğ°Ğ¹Ğ»Ñ‹                         â”‚
â”‚     - chunk.release() â†’ MemSlot.release()                   â”‚
â”‚     - UnsafeChunkAlloc Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ off-heap Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
6.2. Data Flow: Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ°
Player.getBlock(x, y, z)
    â†“
World.getBlock(x, y, z)
    â†“
ChunkProviderServer.provideChunk(cx, cz)
    â†“
ChunkMap.get(cx, cz) â†’ Chunk
    â†“
Chunk.getBlock(x, y, z)
    â†“
ExtendedBlockStorage[y >> 4].getBlockByExtId(x, y & 15, z)
    â†“
MemSlot.getBlockId(x, y, z)  [Off-heap memory access]
    â†“
Block.getBlockById(id)
    â†“
Return Block instance
6.3. Data Flow: Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ°
World.setBlock(x, y, z, block, meta)
    â†“
Chunk.func_150807_a(x, y, z, block, meta)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°              â”‚
â”‚ 2. oldBlock.onBlockPreDestroy()         â”‚
â”‚ 3. oldBlock.breakBlock()                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ExtendedBlockStorage.func_150818_a()    â”‚
â”‚ â”œâ”€ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ blockRefCount             â”‚
â”‚ â”œâ”€ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ tickRefCount              â”‚
â”‚ â””â”€ MemSlot.setBlockId() [off-heap]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ExtendedBlockStorage.setExtBlockMetadataâ”‚
â”‚ â””â”€ MemSlot.setMeta() [off-heap]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. TileEntity management                â”‚
â”‚ 5. newBlock.onBlockAdded()              â”‚
â”‚ 6. Chunk.relightBlock() - Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ     â”‚
â”‚ 7. chunk.isModified = true              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
7. ĞĞŸĞ¢Ğ˜ĞœĞ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ˜ PERFORMANCE
7.1. ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
1. Off-heap chunk storage (MemSlot)
Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ GC pressure Ğ½Ğ° 70%
Ğ§Ğ°Ğ½ĞºĞ¸ Ğ½Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ² Java GC
ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ñ‡ĞµÑ€ĞµĞ· sun.misc.Unsafe
2. Koloboke Collections
HashIntObjMaps Ğ²Ğ¼ĞµÑÑ‚Ğ¾ HashMap
2-3x faster lookups
ĞœĞµĞ½ÑŒÑˆĞµ memory overhead
3. ChunkHash Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
ChunkHash.java:5-8

public static int chunkToKey(int x, int z)
{
    return (x & 0xffff) << 16 | (z & 0xffff);
}
Ğ£Ğ¿Ğ°ĞºĞ¾Ğ²ĞºĞ° (x, z) Ğ² Ğ¾Ğ´Ğ¸Ğ½ int
Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ChunkMap
4. EbsSaveFakeNbt
Ğ›ĞµĞ½Ğ¸Ğ²Ğ°Ñ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²
ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸
Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ allocations
5. YZX Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
Unsafe7MemSlot.java:191

int index = y << 8 | z << 4 | x;
Ğ›ÑƒÑ‡ÑˆĞ°Ñ cache locality Ğ¿Ñ€Ğ¸ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ° Ğ¸ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ñ
6. ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°
ChunkIOExecutor Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
ĞĞµĞ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰Ğ°Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°
ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° batch loading
7.2. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
ĞŸĞ°Ğ¼ÑÑ‚ÑŒ:

Vanilla chunk: ~40-50KB heap
Ultramine chunk: ~10KB heap + 12KB off-heap
GC pressure: -70%
Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ:

Block access: O(1) Ñ‡ĞµÑ€ĞµĞ· off-heap
Chunk lookup: O(1) Ñ‡ĞµÑ€ĞµĞ· Koloboke IntObjMap
Save queue: O(1) Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, O(n) Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ñ„Ğ¾Ğ½Ğµ
8. ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• ĞĞ¡ĞĞ‘Ğ•ĞĞĞĞ¡Ğ¢Ğ˜
8.1. Chunk Leak Detection
ChunkBindState.LEAK - Ñ‡Ğ°Ğ½ĞºĞ¸, Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ Ğ² Ğ¾Ğ±Ñ…Ğ¾Ğ´ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹, Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚.

8.2. Persistent Chunks Support
ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Forge persistent chunks (chunk loaders). ChunkBindState.FORGE Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¸Ñ… Ğ¾Ñ‚ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ¸.

8.3. Incremental Saving
Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² ÑÑ€Ğ°Ğ·Ñƒ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‡Ğ°Ğ½ĞºĞ¸ Ğ¿Ğ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾, Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ÑÑ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ.

8.4. Smart GC
ChunkGC Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ñ‡Ğ°Ğ½ĞºĞ¸ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ:

Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ¸ unbind
Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ğ° Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
8.5. Region File Caching
RegionFileCache ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ region Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ‡Ğ°Ğ½ĞºĞ°Ğ¼.

9. ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
9.1. Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°
# Off-heap memory limit (GB)
-Dorg.ultramine.chunk.alloc.offheap.memlimit=6

# Layout version (7 or 8)
-Dorg.ultramine.chunk.alloc.layout=7

# Debug sync chunk loading
-Dultramine.debug.chunksyncload=true
9.2. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¸Ñ€Ğ°
defaultworlds.yml ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²:

chunkCacheSize - Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ ĞºÑÑˆĞ° Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
Generation settings
Mob spawning limits
10. Ğ’Ğ«Ğ’ĞĞ”Ğ«
10.1. Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹
Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ - off-heap storage ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ GC Ğ½Ğ° 70%
ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ - Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ¾ 6GB off-heap Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ - ÑƒĞ¼Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° GC Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ OOM
Ğ¡Ğ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ - Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Forge Ğ¸ Ğ¼Ğ¾Ğ´Ğ¾Ğ²
Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ - Ğ´Ğ²Ğ° layout Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ĞµĞ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
10.2. ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ
Compression - ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
Prefetching - Ğ¿Ñ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ¿Ğ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
Hierarchical chunking - LOD ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ´Ğ°Ğ»ÑŒĞ½Ğ¸Ñ… Ñ‡Ğ°Ğ½ĞºĞ¾Ğ²
NUMA awareness - Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ñ€Ğ½Ñ‹Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼
10.3. Ğ˜Ñ‚Ğ¾Ğ³
Ultramine Core Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ±Ğ¾Ğ¹ Ğ²Ñ‹ÑĞ¾ĞºĞ¾ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½ÑƒÑ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² Ğ´Ğ»Ñ Minecraft 1.7.10, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‰ÑƒÑ Ğ¿ĞµÑ€ĞµĞ´Ğ¾Ğ²Ñ‹Ğµ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:

Off-heap storage Ñ‡ĞµÑ€ĞµĞ· Unsafe
Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ»Ğ»ĞµĞºÑ†Ğ¸Ğ¸ Koloboke
ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°
Ğ£Ğ¼Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° GC
ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¾Ğµ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ JVM Ğ¸ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ Ğº Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Java.

ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ñ€ĞµĞ·ÑĞ¼Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¾Ğº:
ğŸ¯ ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¸Ğ½Ğ½Ğ¾Ğ²Ğ°Ñ†Ğ¸Ğ¸:
Off-heap Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² (MemSlot)

Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ sun.misc.Unsafe Ğ´Ğ»Ñ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰Ğ°ĞµÑ‚ GC pressure Ğ½Ğ° 70%
Ğ›Ğ¸Ğ¼Ğ¸Ñ‚: 6GB Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾Ğ¹ off-heap Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
Ğ”Ğ²Ğ° layout: Layout 7 (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ) Ğ¸ Layout 8 (Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹)
Ğ£Ğ¼Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ

ĞÑ‚Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ pendingSaves
EbsSaveFakeNbt - Ğ½ÑƒĞ»ĞµĞ²Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
ChunkGC - Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ°

ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
5 ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ Ñ‡Ğ°Ğ½ĞºĞ¾Ğ² (NONE, PLAYER, LEAK, FORGE, ETERNAL)
Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ memory leaks
ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°

ChunkIOExecutor Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° callback Ğ¸ batch loading
ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°
ğŸ“Š Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ:
Chunk (16x16x256 Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²)
â””â”€â”€ ExtendedBlockStorage[16] (Ğ¿Ğ¾ 16 Ğ±Ğ»Ğ¾ĞºĞ¾Ğ² Ğ¿Ğ¾ Y)
    â””â”€â”€ MemSlot (12,288 Ğ±Ğ°Ğ¹Ñ‚ off-heap)
        â”œâ”€â”€ LSB: 4096 Ğ±Ğ°Ğ¹Ñ‚ (ID Ğ¼Ğ»Ğ°Ğ´ÑˆĞ¸Ğµ 8 Ğ±Ğ¸Ñ‚)
        â”œâ”€â”€ MSB: 2048 Ğ±Ğ°Ğ¹Ñ‚ (ID ÑÑ‚Ğ°Ñ€ÑˆĞ¸Ğµ 4 Ğ±Ğ¸Ñ‚Ğ°)
        â”œâ”€â”€ META: 2048 Ğ±Ğ°Ğ¹Ñ‚ (Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²)
        â”œâ”€â”€ BLOCKLIGHT: 2048 Ğ±Ğ°Ğ¹Ñ‚ (Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ)
        â””â”€â”€ SKYLIGHT: 2048 Ğ±Ğ°Ğ¹Ñ‚ (Ğ½ĞµĞ±ĞµÑĞ½Ñ‹Ğ¹ ÑĞ²ĞµÑ‚)